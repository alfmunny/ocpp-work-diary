---
layout: post
title: Backend System von OCPP für Ladestation
date: 2014-07-23
---
# Grundlage

## Aktueller Stand in EU


Driven by international incentives to reduce greenhouse gas emissions,
interest in Electric Vehicle (EV) technology is growing rapidly throughout the world.
To achieve the *EU 20-20-20* targets, EVs will be massively rolled out across Europe
Existing electricity networks are constrained by how much additional capacity
they can provide for the high integration of EV recharging systems;
taking into account additional emerging requirements for instance:
the electrification of residential heating and the increase in distributed renewable generation.
Such changes can be offset by a move towards a smarter network.[1]

Important Elements:[1]

* Battery Technology
* Electric Vehicle Supply Equipment (EVSE)
* Information and Communication Technology (ICT)

  giving support to their management, operation and maintenance.[4]

* Energy Management Systems

Important Roles:[4]

* EV
* EVSE(EV Supply Equipment)
* EVSP(EV Service Provider)

Papers:

>[1. AC Recharging Infrastructure for EVs and Future Smart Grid](https://www.dropbox.com/s/28h7468lqdlhlbn/Kirby%20%E5%92%8C%20Hassan%20-%202012%20-%20AC%20Recharging%20Infrastructure%20for%20EVs%20and%20future%20sm.pdf)

>[2. Integrating EVs into the Smart-Grid](https://www.dropbox.com/s/5494hcxqityy3sw/Kovacs%20%E7%AD%89.%20-%202013%20-%20Integrating%20EVs%20into%20the%20Smart-Grid.pdf)

>[3. A back-end system for an autonomous parking and charging system for electric vehicles](https://www.dropbox.com/s/7a7vctnf09isvl4/Timpner%20%E5%92%8C%20Wolf%20-%202012%20-%20A%20back-end%20system%20for%20an%20autonomous%20parking%20and%20ch.pdf)

>[4. A communication system from EV to EV Service Provider based on OCPP over a wireless network](https://www.dropbox.com/s/4wssickc5it41vh/Rodriguez-Serrano%20%E7%AD%89.%20-%202013%20-%20A%20communication%20system%20from%20EV%20to%20EV%20Service%20Provi.pdf)

>[5. An ICT solution for integration of Electric Vehicles in grid balancing services](https://www.dropbox.com/s/x9fb9b4sftr3or0/Lewandowski%20%E7%AD%89.%20-%202013%20-%20An%20ICT%20solution%20for%20integration%20of%20Electric%20Vehicl.pdf)

Wiki links:

[Interoperability](http://en.wikipedia.org/wiki/Interoperability)

[Charge Station](http://en.wikipedia.org/wiki/Charging_station)

Articles and examples:

[The Ultimate Guide to Electric Car Charging Networks](http://www.plugincars.com/ultimate-guide-electric-car-charging-networks-126530.html)

[SKY Network](http://www.bosch-si.com/de/loesungen/mobility/unsere-loesungen/ocpp.html)

*EU 20-20-20:*

Die Notwendigkeit einer Steigerung der Energieeffizienz ist
Teil des „20-20-20-Ziels“ für das Jahr 2020,
das eine Senkung des Primärenergieverbrauchs der Union und der Treibhausgasemissionen um jeweils 20%
sowie eine Anhebung des Anteils der erneuerbaren Energiequellen auf 20 % umfasst.

[Energy Efficiency](http://europa.eu/legislation_summaries/energy/energy_efficiency/en0002_de.htm)

[Klima und Umwelt](http://www.e-control.at/de/konsumenten/oeko-energie/klima-und-umwelt/20-20-20-ziele)

![PEV Sales by Quarter ]({{ site.url }}/images/屏幕快照 2014-07-20 22.12.06.png)

[source: Plug-in Electric Vehicles Where Are We And What’s Next](EPRI-ET-Update_2013-11-21.pdf)

## OCPP: Open Charge Point Protocol
[OCPP](http://www.openchargealliance.org/) is short for Open Charge Point Protocol,
a popular language used for communications between

Developed by: [**E-Laad Foundation**](http://www.e-laad.nl/)

charging station hardware made by
- ABB, Aeroviron- ment, Bosch, DBT, Eaton, Fuji, Schneider, Siemens, etc.

and the managing network systems
- like ChargePoint, ECOtality, eVgo, Greenlots, OpConnect, SemaConnect, etc.

Useful links:

[Wiki Open Charge Point Protocol](http://en.wikipedia.org/wiki/Open_Charge_Point_Protocol)

OCPP Description:

[OCPP 1.5 description](http://www.openchargealliance.org/sites/default/files/ocpp%201%205%20-%20a%20functional%20description%20v2%200_0_0.pdf)

OCPP Specification:
[OCPP 1.5 specification](http://www.openchargealliance.org/sites/default/files/ocpp_specification_1.5_final.pdf)

WSDL files of OCPP:

[OCPP Central System service description](http://www.openchargealliance.org/sites/default/files/ocpp_centralsystemservice_1.5_final.wsdl)

[OCPP Central System service description](http://www.openchargealliance.org/sites/default/files/ocpp_chargepointservice_1.5_final.wsdl)

![Signalverlauf von OCPP und Mode 3]({{ site.url }}/images/屏幕快照 2014-07-21 13.45.34.png)

**Controversy**:

**In the US**, however, OCPP hasn’t quite swept across the charging industry as it has elsewhere, and much of the EVSE that has been deployed was designed prior to OCPP being widely adopted.

The US OCPP controversy mainly stems from the fact that two companies (ECOtality and ChargePoint)
have been the largest recipients of the government grants that kick-started the industry, and they
don’t exclusively use OCPP. In many cases those networks use proprietary communication protocols
that are unique to each com- pany. The gist of the gripe is that tax money was spent to give these
companies a stranglehold on these publicly- funded installs - “vendor lock-in,” as some call it.

### Difference between OCPP and Collaboratev

*OCPP*

- Provides a standard path from EVSE to EVSP
- Enables EVSE owner to change networks without replacing hardware
- Prevents EVSE being stranded by a network provider going out of business
- Doesn’t address roaming across networks or common user credentials

**Network Clearing House like Collaboratev or Hubject**

- Allows consumers to roam across networks (note that the consumer may have
to pay a roaming charge)
- All networks must participate to enable seamless roaming for consumers
- Needs to provide a common user credential to fully address roaming
- There is a cost for this service – someone must pay
- EVSE can still use a proprietary backhaul and participate
- Doesn’t prevent stranded EVSE if a network provide fails

[Charge Magazine OCPP](http://greenlots.com/wp-content/uploads/2013/06/Charge-Magazine-OCPP-Jun-2013.pdf)

[Plug-in Electric Vehicles Where Are We And What’s Next](EPRI-ET-Update_2013-11-21.pdf)


## SOAP

SOAP, originally defined as Simple Object Access Protocol, is a protocol specification for exchanging structured information in the implementation of web services in computer networks. It relies on XML Information Set for its message format, and usually relies on other application layer protocols, most notably Hypertext Transfer Protocol (HTTP) or Simple Mail Transfer Protocol (SMTP), for message negotiation and transmission.

![Structure]({{ site.url }}/images/SOAP.svg)

Example message:

```
POST /InStock HTTP/1.1
Host: www.example.org
Content-Type: application/soap+xml; charset=utf-8
Content-Length: 299
SOAPAction: "http://www.w3.org/2003/05/soap-envelope"
<?xml version="1.0"?>
<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope">
  <soap:Header>
  </soap:Header>
  <soap:Body>
    <m:GetStockPrice xmlns:m="http://www.example.org/stock">
      <m:StockName>IBM</m:StockName>
    </m:GetStockPrice>
  </soap:Body>
</soap:Envelope>
```

Communication:

![image]({{ site.url }}/images/屏幕快照 2014-07-21 11.45.16.png)

Useful links:

[Wiki SOAP](http://en.wikipedia.org/wiki/SOAP)

## WSDL

The Web Services Description Language (WSDL pronounced "wiz'-dul") is an XML-based interface definition language that is used for describing the functionality offered by a web service. The acronym is also used for any specific WSDL description of a web service (also referred to as a WSDL file), which provides a machine-readable description of how the service can be called, what parameters it expects, and what data structures it returns. It thus serves a purpose that corresponds roughly to that of a method signature in a programming language.

Useful links:

[Wiki WSDL](http://de.wikipedia.org/wiki/Web_Services_Description_Language)

## Web Service

A software system designed to support interoperable machine-to-machine interaction over a network. It has an interface described in a machine-processable format (specifically WSDL). Other systems interact with the Web service in a manner prescribed by its description using SOAP messages, typically conveyed using HTTP with an XML serialization in conjunction with other Web-related standards.

![Web Service]({{ site.url }}/images/Webservices.png)

Useful links:
[Wiki Web Service](http://en.wikipedia.org/wiki/Web_service)

[Wiki UDDI](http://en.wikipedia.org/wiki/Universal_Description_Discovery_and_Integration)

[w3schools UDDI](http://www.w3schools.com/webservices/ws_wsdl_uddi.asp)

## Discussions of SOAP, JSON, REST, WSDL, XML

Useful links:

[JSON, REST, SOAP, WSDL, and SOA: How do they all link together](http://stackoverflow.com/questions/16626021/json-rest-soap-wsdl-and-soa-how-do-they-all-link-together)

[Describe REST Web services with WSDL 2.0](http://www.ibm.com/developerworks/webservices/library/ws-restwsdl/)

[Web Services Explained](http://www.service-architecture.com/articles/web-services/web_services_explained.html)

[WSDL for SOAP and WSDL for REST and REST based on JSON](http://stackoverflow.com/questions/5936380/wsdl-for-soap-and-wsdl-for-rest-and-rest-based-on-json)

### Frontend and Backend

Frontend:

- Ember.js

Backend:

- Node.js
- Ruby on Rails

Useful links:

[Ember Cli with Rails Part 1](http://reefpoints.dockyard.com/2014/05/07/building-an-ember-app-with-rails-part-1.html)

# Research of OCPP Backend

## Simulator

[ocppjs - An experimental OCPP Simulator](http://www.gir.fr/ocppjs/)

The simulator can send JSON request with JSON-schema.


[Principle of JSON-schema](http://jeremydorn.com/json-editor/)

[json-schema.org](http://json-schema.org/)

Communication with POSTMAN

[POSTMAN](http://www.getpostman.com/)

## soapUI
[SoapUI - The Home of Functional Testing](http://www.soapui.org/)

## Communication with AJAX
[http://powerful-dusk-5787.herokuapp.com/](http://powerful-dusk-5787.herokuapp.com/)

## node-soap

[Github: node-soap](https://github.com/vpulim/node-soap)

I have written a test demo using node-soap. Fetch the coad on my [Github](https://github.com/alfmunny/node-soap-demo).

* server.js{% highlight javascript %}
var http = require('http');
var soap = require('soap');
var ocppCentralSystemService = {
  CentralSystemService: {
    CentralSystemServiceSoap12: {
      Heartbeat: function(args) {
									console.log("/Heartbeat");
									var dateTime = new Date();
									console.log(dateTime.toString());
         return { currentTime: dateTime.toString() };
      },
			Authorize: function(args) {
										 console.log("/Authorize");
										 return { idTagInfo: {} };
			}
    }
  }
}
var xml = require('fs').readFileSync('ocpp_centralsystemservice_1.5_final.wsdl', 'utf8'),
      server = http.createServer(function(request,response) {
          response.end("404: Not Found: "+request.url)
      });
server.listen(9000);
soap.listen(server, '/', ocppCentralSystemService, xml);{% endhighlight %}

* client.js{% highlight javascript %}
var soap = require('soap');
var url = 'http://localhost:9000/?wsdl';
var args = {};
var soapHeader = '<tns:chargeBoxIdentity soap:mustUnderstand="true">' +
                    'boxid' +
                  '</tns:chargeBoxIdentity>' +
                  '<wsa5:To soap:mustUnderstand="true">' +
                    'http://localhost:9000' +
                  '</wsa5:To>' +
                  '<wsa5:Action soap:mustUnderstand="true">' +
                    '/Heartbeat' +
                  '</wsa5:Action>';
soap.createClient(url, {endpoint:'http://localhost:9000/'}, function(err, client) {
  if (err) throw err;
    console.log(client.describe().CentralSystemService.CentralSystemServiceSoap12.Authorize);
		client.addSoapHeader(soapHeader);
    client.Heartbeat(args, function(err, result) {
      if (err) throw err;
        console.log(result);
      });
    client.Authorize({idTag: ''}, function(err, result) {
      if (err) throw err;
        console.log(result);
      });
});{% endhighlight %}

### Test with Postman
Send SOAP request to node soap through POSTMAN to this demo server and get the identical respond back √
